<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard | Olymp</title>
    <link rel="stylesheet" href="./css/dashboards.css" />
  </head>

  <body>
    <aside class="sidebar">
      <div class="user-name" id="userName">Ol√°, @</div>
      <nav>
        <a href="./index.html">Home</a>
      </nav>
    </aside>

    <div class="content">
      <div class="kpis-container">
        <div class="kpi">
          Taxa Quiz F√°cil
          <div class="value" id="kpi-facil" style="color: #4caf50">90%</div>
          <div class="kpi-subtitle">Desempenho no n√≠vel F√°cil</div>
        </div>
        <div class="kpi">
          Taxa Quiz M√©dio
          <div class="value" id="kpi-medio" style="color: #ffc107">60%</div>
          <div class="kpi-subtitle">Desempenho no n√≠vel M√©dio</div>
        </div>
        <div class="kpi">
          Taxa Quiz Dif√≠cil
          <div class="value" id="kpi-dificil" style="color: #f44336">30%</div>
          <div class="kpi-subtitle">Desempenho no n√≠vel Dif√≠cil</div>
        </div>
      </div>

      <div class="main-container">
        <div class="container">
          <canvas id="myChart"></canvas>
        </div>

        <div id="ranking">
          <div class="ranking">
            <h3>üèÜ Ranking dos Jogadores</h3>
            <ol id="ranking-list">
              <li>Jogador 1 - 150 pts</li>
              <li>Jogador 2 - 120 pts</li>
              <li>Jogador 3 - 90 pts</li>
            </ol>
          </div>
        </div>
      </div>
    </div>

    <!-- Script para gerar gr√°fico -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>


      async function carregarDados() {
        const idUsuario = sessionStorage.ID_USUARIO;

        if (!idUsuario) {
          alert("Usu√°rio n√£o logado!");
          window.location.href = "./login.html";
          return;
        }

        // Atualiza nome usu√°rio mesmo se API der erro
        const nomeUsuario = sessionStorage.NOME_USUARIO || "Usu√°rio";
        document.getElementById("userName").innerText = `Ol√°, @${nomeUsuario}`;

        try {
          // Dados desempenho
          const resposta = await fetch(
            `http://localhost:3333/quiz/desempenho/${idUsuario}`
          );
          if (!resposta.ok)
            throw new Error(`Erro ao buscar desempenho: ${resposta.status}`);
          const dados = await resposta.json();

          const desempenhoFacil = dados.find(d => d.IdQuiz == 1);
          const desempenhoMedio = dados.find(d => d.IdQuiz == 2);
          const desempenhoDificil = dados.find(d => d.IdQuiz == 3);

          const taxaFacil = desempenhoFacil ? Number(desempenhoFacil.percentual) : 0;
          const taxaMedio = desempenhoMedio ? Number(desempenhoMedio.percentual) : 0;
          const taxaDificil = 20;

          // Atualiza KPIs
          document.getElementById("kpi-facil").innerText = `${taxaFacil}%`;
          document.getElementById("kpi-medio").innerText = `${taxaMedio}%`;
          document.getElementById("kpi-dificil").innerText = `${taxaDificil}%`;
          console.log("Dificil:", dados.find(d => d.IdQuiz == 3));

          console.log("Valores para o gr√°fico:", [taxaFacil, taxaMedio, taxaDificil]);
          // Atualiza gr√°fico
          myChart.data.datasets[0].data = [taxaFacil, taxaMedio, taxaDificil];
          myChart.update();

          // Dados ranking geral
          const respostaRanking = await fetch(
            `http://localhost:3333/quiz/ranking`
          );
          if (!respostaRanking.ok)
            throw new Error(
              `Erro ao buscar ranking: ${respostaRanking.status}`
            );
          const ranking = await respostaRanking.json();

          const rankingList = document.getElementById("ranking-list");
          rankingList.innerHTML = "";

          ranking.forEach((jogador) => {
            const li = document.createElement("li");
            li.innerText = `${jogador.nome} - ${jogador.total_pontuacao} pts`;
            rankingList.appendChild(li);
          });
        } catch (error) {
          console.error("Erro ao carregar dados:", error);
          alert(
            "N√£o foi poss√≠vel carregar os dados da dashboard. Tente novamente mais tarde."
          );
        }
      }

         const ctx = document.getElementById("myChart").getContext("2d");
      const myChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["F√°cil", "M√©dio", "Dif√≠cil"],
          datasets: [
            {
              label: "Taxa de Acerto (%)",
              data: [10, 30, 90], // Come√ßa vazio, ser√° atualizado
              backgroundColor: ["#4caf50", "#ffc107", "#f44336"],
              borderColor: ["#388e3c", "#ffa000", "#d32f2f"],
              borderWidth: 1,
            },
          ],
        },
        options: {
          scales: {
            y: { beginAtZero: true, max: 100 },
          },
        },
      });

      carregarDados();
      
    </script>
  </body>
</html>
