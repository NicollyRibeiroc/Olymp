<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css?family=Poppins" rel="stylesheet" />
    <link rel="stylesheet" href="./css/login.css" />
    <title>Login | Olymp</title>
</head>

<body>
    <div class="container">
        <div class="bloco_foto">
            <div class="bloco_login">
                <h1 class="login">Login</h1>

                <input id="input_email" class="input" placeholder="E-mail" type="text" />
                <input id="input_senha" class="input" placeholder="Senha" type="password" />
                <button class="botao" onclick="entrar()">Login</button>

                <!-- Div onde vou mostrar mensagens de erro para o usuário -->
                <div id="cardErro" style="display:none; color:red; margin-top:10px;"></div>

                <h4>Não é cadastrado? Clique <a href="cadastro.html">aqui</a> para se cadastrar</h4>
            </div>
        </div>
    </div>

    <script>
        // Função que executa quando o usuário clica no botão de login
        function entrar() {
            // Pego o valor digitado no campo email e tiro espaços extras
            var emailVar = document.getElementById("input_email").value.trim();
            // Pego o valor digitado no campo senha e tiro espaços extras
            var senhaVar = document.getElementById("input_senha").value.trim();
            // Pego o elemento onde vou mostrar a mensagem de erro
            var cardErro = document.getElementById("cardErro");

            // Antes de tudo, escondo qualquer mensagem de erro que estivesse aparecendo
            cardErro.style.display = "none";
            cardErro.innerHTML = "";

            // Verifico se algum dos campos está vazio
            if (emailVar === "" || senhaVar === "") {
                // Se estiverem vazios, mostro a mensagem de erro para o usuário
                cardErro.style.display = "block";
                cardErro.innerHTML = "Por favor, preencha todos os campos!";
                // Saio da função para não continuar o processo de login
                return false;
            }

            // Mostro no console o email e senha que o usuário digitou (pra ajudar a debugar)
            console.log("FORM LOGIN: ", emailVar);
            console.log("FORM SENHA: ", senhaVar);

            // Faço uma requisição POST para o backend, enviando email e senha para autenticação
            fetch("/usuarios/autenticar", {
                method: "POST", // método POST para enviar dados
                headers: {
                    "Content-Type": "application/json" // meu conteúdo é JSON
                },
                body: JSON.stringify({
                    emailServer: emailVar, // mando o email no corpo da requisição
                    senhaServer: senhaVar   // mando a senha no corpo da requisição
                })
            }).then(function (resposta) {
                // Se o backend responder que deu certo (status 200)
                if (resposta.ok) {
                    // Converto a resposta em JSON para pegar os dados do usuário
                    resposta.json().then(json => {
                        console.log("Usuário autenticado:", json);

                        // Salvo as informações do usuário no sessionStorage para manter sessão ativa
                        sessionStorage.EMAIL_USUARIO = json.email;
                        sessionStorage.NOME_USUARIO = json.nome;
                        sessionStorage.ID_USUARIO = json.idUsuario;

                        // Depois redireciono o usuário para a página principal (index.html)
                        window.location.href = "index.html";
                    });
                } else {
                    // Se deu erro no login, pego o texto do erro que o backend enviou
                    resposta.text().then(texto => {
                        // Mostro essa mensagem de erro na tela para o usuário
                        cardErro.style.display = "block";
                        cardErro.innerHTML = texto || "Email ou senha inválidos!";
                        // Também mostro no console para eu poder corrigir se precisar
                        console.error("Erro no login:", texto);
                    });
                }
            }).catch(function (erro) {
                // Caso dê algum problema na conexão com o backend, mostro essa mensagem
                cardErro.style.display = "block";
                cardErro.innerHTML = "Erro ao conectar com o servidor.";
                console.error("Erro de conexão:", erro);
            });

            // Evito que o formulário seja enviado da forma tradicional (recarregando a página)
            return false;
        }
    </script>
</body>

</html>